@inherits LayoutComponentBase
@inject BackgroundState BgState
@inject EventAggregator Events
@using PacoYakuzaMAUI.utils
@implements IDisposable

@code {
    private Func<Task> _listener;
    private bool _isDisposed = false;

    protected override void OnInitialized()
    {
        _listener = async () => 
        {
            if (!_isDisposed)
            {
                await InvokeAsync(SafeStateHasChanged);
            }
        };
        
        Events.BackgroundChanged += _listener;
    }

    private void SafeStateHasChanged()
    {
        try
        {
            if (!_isDisposed)
            {
                StateHasChanged();
            }
        }
        catch
        {
            // Ignora errores si el componente está disposed
        }
    }

    public void Dispose()
    {
        _isDisposed = true;
        
        if (_listener != null)
        {
            try
            {
                Events.BackgroundChanged -= _listener;
            }
            catch { }
        }
    }
}

<CascadingValue Value="(Action<string>)(style => BgState.MainBackgroundStyle = style)">
    <div class="page">
        <div class="sidebar">
            <NavMenu/>
        </div>
        <main class="main-content" style="@BgState.MainBackgroundStyle">
            <div class="top-row px-4">
                <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
            </div>
            <article class="content px-4" style="@BgState.TextColorStyle">
                @Body
            </article>
        </main>
    </div>
</CascadingValue>